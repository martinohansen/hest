{{define "content"}}
<h1>{{.Player.Emoji}} {{.Player.Name}}</h1>

<div class="player-stats">
  <div class="stat">
    <span class="stat-label responsive-label">
      <span class="label-full">Position</span>
      <abbr class="label-short" title="Position">#</abbr>
    </span>
    <span class="stat-value">{{.Rank}}</span>
  </div>
  <div class="stat">
    <span class="stat-label responsive-label">
      <span class="label-full">Kampe</span>
      <abbr class="label-short" title="Kampe">K</abbr>
    </span>
    <span class="stat-value">{{.Player.Games}}</span>
  </div>
  <div class="stat">
    <span class="stat-label responsive-label">
      <span class="label-full">Vundet</span>
      <abbr class="label-short" title="Vundet">V</abbr>
    </span>
    <span class="stat-value">{{.Player.Wins}}</span>
  </div>
  <div class="stat">
    <span class="stat-label responsive-label">
      <span class="label-full nowrap">2. plads</span>
      <abbr class="label-short" title="2. plads">2</abbr>
    </span>
    <span class="stat-value">{{.Player.Seconds}}</span>
  </div>
  <div class="stat">
    <span class="stat-label responsive-label">
      <span class="label-full">Point</span>
      <abbr class="label-short" title="Point">P</abbr>
    </span>
    <span class="stat-value">{{.Player.Points}}</span>
  </div>
  <div class="stat">
    <span class="stat-label responsive-label">
      <span class="label-full nowrap">Point pr. kamp</span>
      <abbr class="label-short" title="Point pr. kamp">PPK</abbr>
    </span>
    <span class="stat-value">{{printf "%.2f" .Player.PPG}}</span>
  </div>
</div>

{{if .HasGames}}
<h2 class="stat-label">Points pr. kamp</h2>
<canvas id="ppg-chart"></canvas>

<h2 class="stat-label" style="margin-top: 2rem">Placering</h2>
<canvas id="rank-chart"></canvas>

<h2 class="stat-label" style="margin-top: 2rem"></h2>
<table class="table">
  <thead>
    <tr>
      <th>Dato</th>
      <th class="nowrap">Vinder</th>
      <th class="nowrap">2. plads</th>
      <th class="hide-small">Deltagere</th>
    </tr>
  </thead>
  <tbody>
    {{range .Games}}
    <tr>
      <td>{{.PlayedAt.Format "2006-01-02"}}</td>
      <td class="nowrap">
        <a href="/player?id={{.Winner.ID}}"
          >{{.Winner.Emoji}} {{.Winner.Name}}</a
        >
      </td>
      <td class="nowrap">
        <a href="/player?id={{.Second.ID}}"
          >{{.Second.Emoji}} {{.Second.Name}}</a
        >
      </td>
      <td class="hide-small">
        {{range .Participants}}<a href="/player?id={{.ID}}" title="{{.Name}}"
          >{{.Emoji}}</a
        >{{end}}
      </td>
    </tr>
    {{end}}
  </tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  const gameHistory = [
    {{range .GameHistory}}
    {
      date: "{{.PlayedAt.Format "01/02"}}",
      ppg: {{printf "%.2f" .PPG}}
    },
    {{end}}
  ];

  const rankHistory = [
    {{range .RankHistory}}
    {
      date: "{{.PlayedAt.Format "01/02"}}",
      rank: {{.Rank}}
    },
    {{end}}
  ];

  const labels = gameHistory.map(g => g.date);
  const ppgData = gameHistory.map(g => parseFloat(g.ppg));

  new Chart(document.getElementById('ppg-chart'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'PPK',
        data: ppgData,
        borderColor: '#464646',
        backgroundColor: 'rgba(70, 70, 70, 0.1)',
        tension: 0.1,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 2,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            precision: 2
          }
        }
      }
    }
  });

  // Rank chart
  const rankLabels = rankHistory.map(r => r.date);
  const rankData = rankHistory.map(r => r.rank);

  new Chart(document.getElementById('rank-chart'), {
    type: 'line',
    data: {
      labels: rankLabels,
      datasets: [{
        label: 'Placering',
        data: rankData,
        borderColor: '#464646',
        tension: 0.1,
        fill: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 2,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return 'Plads ' + context.parsed.y;
            }
          }
        }
      },
      scales: {
        y: {
          reverse: true,
          beginAtZero: false,
          min: 1,
          max: {{.TotalPlayers}},
          ticks: {
            stepSize: 1,
            precision: 0
          }
        }
      }
    }
  });
</script>
{{else}}
<p>Ingen kampe registreret endnu.</p>
{{end}} {{end}}
