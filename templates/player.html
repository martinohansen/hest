{{define "content"}}
<h1>{{.Player.Emoji}} {{.Player.Name}}</h1>

<div class="player-stats">
  <div class="stat">
    <span class="stat-label responsive-label">
      <span class="label-full">Position</span>
      <abbr class="label-short" title="Position">#</abbr>
    </span>
    <span class="stat-value">{{.Rank}}</span>
  </div>
  <div class="stat">
    <span class="stat-label responsive-label">
      <span class="label-full">Kampe</span>
      <abbr class="label-short" title="Kampe">K</abbr>
    </span>
    <span class="stat-value">{{.Player.Games}}</span>
  </div>
  <div class="stat">
    <span class="stat-label responsive-label">
      <span class="label-full">Vundet</span>
      <abbr class="label-short" title="Vundet">V</abbr>
    </span>
    <span class="stat-value">{{.Player.Wins}}</span>
  </div>
  <div class="stat">
    <span class="stat-label responsive-label">
      <span class="label-full nowrap">2. plads</span>
      <abbr class="label-short" title="2. plads">2</abbr>
    </span>
    <span class="stat-value">{{.Player.Seconds}}</span>
  </div>
  <div class="stat">
    <span class="stat-label responsive-label">
      <span class="label-full">Point</span>
      <abbr class="label-short" title="Point">P</abbr>
    </span>
    <span class="stat-value">{{.Player.Points}}</span>
  </div>
  <div class="stat">
    <span class="stat-label responsive-label">
      <span class="label-full nowrap">Point pr. kamp</span>
      <abbr class="label-short" title="Point pr. kamp">PPK</abbr>
    </span>
    <span class="stat-value">{{printf "%.2f" .Player.PPG}}</span>
  </div>
</div>

{{if .HasGames}}
<h2 class="stat-label">Points pr. kamp</h2>
<canvas id="ppg-chart"></canvas>

<h2 class="stat-label" style="margin-top: 2rem">Placering</h2>
<canvas id="rank-chart"></canvas>

<h2 class="stat-label" style="margin-top: 2rem"></h2>
<table class="table">
  <thead>
    <tr>
      <th>Dato</th>
      <th class="nowrap">Vinder</th>
      <th class="nowrap">2. plads</th>
      <th class="hide-small">Deltagere</th>
    </tr>
  </thead>
  <tbody>
    {{range .Games}}
    <tr>
      <td>{{.PlayedAt.Format "2006-01-02"}}</td>
      <td class="nowrap">
        <a href="/player?id={{.Winner.ID}}"
          >{{.Winner.Emoji}} {{.Winner.Name}}</a
        >
      </td>
      <td class="nowrap">
        <a href="/player?id={{.Second.ID}}"
          >{{.Second.Emoji}} {{.Second.Name}}</a
        >
      </td>
      <td class="hide-small">
        {{range .Participants}}<a href="/player?id={{.ID}}" title="{{.Name}}"
          >{{.Emoji}}</a
        >{{end}}
      </td>
    </tr>
    {{end}}
  </tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  const gameHistory = [
    {{range .GameHistory}}
    {
      date: "{{.PlayedAt.Format "01/02"}}",
      ppg: {{printf "%.2f" .PPG}}
    },
    {{end}}
  ];

  const rankHistory = [
    {{range .RankHistory}}
    {
      date: "{{.PlayedAt.Format "01/02"}}",
      rank: {{.Rank}}
    },
    {{end}}
  ];

  const labels = gameHistory.map(g => g.date);
  const ppgData = gameHistory.map(g => parseFloat(g.ppg));

  new Chart(document.getElementById('ppg-chart'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'PPK',
        data: ppgData,
        borderColor: '#464646',
        backgroundColor: 'rgba(70, 70, 70, 0.1)',
        tension: 0.1,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 2,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            precision: 2
          }
        }
      }
    }
  });

  // Rank chart
  const rankLabels = rankHistory.map(r => r.date);
  const rankData = rankHistory.map(r => r.rank);

  new Chart(document.getElementById('rank-chart'), {
    type: 'line',
    data: {
      labels: rankLabels,
      datasets: [{
        label: 'Placering',
        data: rankData,
        borderColor: '#464646',
        tension: 0.1,
        fill: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 2,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return 'Plads ' + context.parsed.y;
            }
          }
        }
      },
      scales: {
        y: {
          reverse: true,
          beginAtZero: false,
          min: 1,
          max: {{.TotalPlayers}},
          ticks: {
            stepSize: 1,
            precision: 0
          }
        }
      }
    }
  });
</script>
{{else}}
<p>Ingen kampe registreret endnu.</p>
{{end}} {{if or (eq .Player.ID 8) (eq .Player.ID 5)}}
<div id="airplane" style="display: none">üõ©Ô∏è</div>
<div id="explosion" style="display: none">üí•</div>

<style>
  #airplane {
    position: fixed;
    font-size: 48px;
    z-index: 9999;
    pointer-events: none;
  }

  #explosion {
    position: fixed;
    font-size: 64px;
    z-index: 10000;
    pointer-events: none;
  }

  @keyframes fly {
    0% {
      left: -100px;
      top: 0%;
    }
    100% {
      left: 100%;
      top: 20%;
    }
  }

  @keyframes explode {
    0% {
      transform: scale(0.5);
      opacity: 1;
    }
    50% {
      transform: scale(1.5);
      opacity: 1;
    }
    100% {
      transform: scale(2);
      opacity: 0;
    }
  }

  .airplane-flying {
    display: block !important;
    animation: fly linear;
  }

  .explosion-active {
    display: block !important;
    animation: explode 0.6s ease-out;
  }
</style>

<script>
  window.addEventListener("load", function () {
    setTimeout(function () {
      const airplane = document.getElementById("airplane");
      const explosion = document.getElementById("explosion");
      const h1 = document.querySelector("h1");

      // Get the position of the player emoji (h1)
      const h1Rect = h1.getBoundingClientRect();
      const targetX = h1Rect.left;
      const targetY = h1Rect.top;

      // Calculate animation duration for constant speed (250px per second)
      const screenWidth = window.innerWidth;
      const distance = screenWidth + 100; // Total distance from -100px to 100% of screen
      const speed = 250; // pixels per second
      const duration = distance / speed;

      airplane.style.animationDuration = duration + "s";
      airplane.classList.add("airplane-flying");

      // Calculate when the airplane reaches the target
      const timeToTarget = (targetX + 100) / speed; // Time in seconds

      // Show explosion when airplane reaches the emoji
      setTimeout(function () {
        explosion.style.left = targetX + "px";
        explosion.style.top = targetY + "px";
        explosion.classList.add("explosion-active");

        // Hide explosion after animation completes
        setTimeout(function () {
          explosion.classList.remove("explosion-active");
          explosion.style.display = "none";
        }, 600);
      }, timeToTarget * 1000);

      // Hide the airplane immediately after animation completes
      setTimeout(function () {
        airplane.style.display = "none";
      }, duration * 1000);
    }, 500);
  });
</script>
{{end}} {{end}}
